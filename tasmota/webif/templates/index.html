{% extends "base_plugin.html" %}
{% set logo_frame = false %}

<!-- set update_interval to a value > 0 (in milliseconds) to enable periodic data updates -->
{% set update_interval = [(((10 * item_count) / 1000) | round | int) * 1000, 5000]|max %}

<!-- Additional styles go into this block. Examples are for datatables -->
{% block pluginstyles %}
<style>
  table th.value {
    width: 100px;
  }
  table th.relais, th.typ, th.lastvalue {
    width: 90px;
  }
  table th.online {
    width: 100px;
  }
  table th.details-control {
    width: 20px;
  }
  table th.device {
    width: 150px;
  }
  table th.plus {
    width: 20px;
  }
  table th.hidden {
    display: none;
    width: 5px;
  }
  table th.zigbee_data {
    width: 400px;
  }
  .shng_effect_highlight {
    background-color: #FFFFE0;
  }
  .shng_effect_standard {
    background-color: none;
  }
</style>
{% endblock pluginstyles %}

<!-- Additional script tag for plugin specific javascript code go into this block -->
{% block pluginscripts %}
<script>
    $(document).ready( function () {
        // Handler responsive Tabelle und deren Überschriften
        /*
        loading defaults from /modules/http/webif/gstatic/datatables/datatables.defaults.js
        You can copy that file, put it in your plugin directory, rename the "bind" function and
        trigger that function here instead of datatables_defaults if you want to change the behaviour.
        Of course you can also overwrite defaults by putting the option declarations in {} below.
        */

        $(window).trigger('datatables_defaults');
        try {
            itemtable = $('#itemtable').DataTable( {
            columnDefs: [   
                { responsivePriority: 1, targets: 1 },
                { responsivePriority: 2, targets: -1 },
                { title: '', targets: 0, "className": "" },
                { title: '{{ _('Item') }}', targets: 1, "className": "item" },
                { title: '{{ _('Typ') }}', targets: 2, "className": "type" },
                { title: '{{ _('Wert') }}', targets: 3, "className": "value" },
                { title: '{{ _('Tasmota Topic') }}', targets: 4, "className": "" },
                { title: '{{ _('Relais') }}', targets: 5, "className": "relais" },
                { title: '{{ _('Letztes Update') }}', targets: 6, "className": "last" },
                { title: '{{ _('Letzter Change') }}', targets: 7, "className": "last" }
                ].concat($.fn.dataTable.defaults.columnDefs),
            });

            devicetable = $('#devicetable').DataTable( {
                "columns": [
                    {"className": "plus"},
                    { title: '{{ _('Tasmota Topic') }}', responsivePriority: 1 },
                    { title: "Online" },
                    { title: "Friendy Name", responsivePriority: 2 },
                    { title: "MAC Adresse" },
                    { title: "IP Adresse" },
                    { title: "Uptime" },
                    { title: "Sensoren" },
                    { title: "Firmware" },
                    { title: "Module" },
                    { title: "Wifi Signal" },
                    { title: "Details" },
                ],
                "order": [[1, 'asc']]
            });
            
            energytable = $('#energytable').DataTable( { 
                columnDefs: [   
                { responsivePriority: 1, targets: 1 },
                { responsivePriority: 2, targets: -1 },
                ].concat($.fn.dataTable.defaults.columnDefs),
            });

            environtable = $('#environtable').DataTable( { 
                columnDefs: [   
                { responsivePriority: 1, targets: 1 },
                { responsivePriority: 2, targets: -1 },
                ].concat($.fn.dataTable.defaults.columnDefs),
            });

            othersensortable = $('#othersensortable').DataTable( { 
                columnDefs: [   
                { responsivePriority: 1, targets: 1 },
                { responsivePriority: 2, targets: -1 },
                ].concat($.fn.dataTable.defaults.columnDefs),
            });

            lightstable = $('#lightstable').DataTable( { 
                columnDefs: [   
                { responsivePriority: 1, targets: 1 },
                { responsivePriority: 2, targets: -1 },
                ].concat($.fn.dataTable.defaults.columnDefs),
            });

            rftable = $('#rftable').DataTable( { 
                columnDefs: [   
                { responsivePriority: 1, targets: 1 },
                { responsivePriority: 2, targets: -1 },
                ].concat($.fn.dataTable.defaults.columnDefs),
            });

            zigbeetable = $('#zigbeetable').DataTable( {
                "columns": [
                    {"className": "plus"},
                    { title: "{{ _('Device ID') }}", responsivePriority: 1 },
                    { title: "{{ _('IEEEAddr') }}" , responsivePriority: 2},
                    { title: "{{ _('Hersteller') }}" },
                    { title: "{{ _('ModelId') }}" },
                    { title: "{{ _('LinkQuality') }}" },
                    { title: "{{ _('Battery %') }}" },
                    { title: "{{ _('LastSeen') }}" },
                    { title: "{{ _('Data') }}" },

                ],
                "order": [[1, 'asc']]
            });
            
            brokertable = $('#brokertable').DataTable( { 
                columnDefs: [   
                { responsivePriority: 1, targets: 1 },
                { responsivePriority: 2, targets: -1 },
                ].concat($.fn.dataTable.defaults.columnDefs),
            });

            brokermontable = $('#brokermontable').DataTable( { 
                columnDefs: [   
                { responsivePriority: 1, targets: 1 },
                { responsivePriority: 2, targets: -1 },
                ].concat($.fn.dataTable.defaults.columnDefs),
            });

        }
        catch (e) {
            console.warn("Datatable JS not loaded, showing standard table without reorder option " + e);
        }
        /*
        This part creates tooltips for buttons/inputs that have the class "button-tooltip"
        */
        const tooltipList = ['Nach Devices suchen'];
        createTooltips(tooltipList);
        /*
        This part reads cookies for the attribute "sort_order" and activates the respective button after page load
        */
        order = getCookie('sort_order');
        if (order == '')
            order = 'time-desc';
        const button = document.getElementById(order);
        button.click();
    });
</script>


<script>
	function handleUpdatedData(response, dataSet=null) {
		if (dataSet === 'devices_info' || dataSet === null) {
			var objResponse = JSON.parse(response);
			myProto = document.getElementById(dataSet);

            for (var item in objResponse['item_values']) {

                const item_val = objResponse['item_values'][item];
				shngInsertText (item+'_value', item_val.value, 'itemtable', 5);
				shngInsertText (item+'_last_update', item_val.last_update, 'itemtable', 5);
				shngInsertText (item+'_last_change', item_val.last_change, 'itemtable', 5);
			}

            for (var device in objResponse['device_values']) {

                const device_val = objResponse['device_values'][device];
				shngInsertText (device+'_online', device_val.online , 'devicetable', 5);
				shngInsertText (device+'_uptime', device_val.uptime , 'devicetable', 5);
				shngInsertText (device+'_fw', device_val.fw_ver , 'devicetable', 5);
                shngInsertText (device+'_wifi', device_val.wifi_signal +' dbm', 'devicetable', 5);

                const sensors = device_val['sensors'];
			    if (sensors) {
			        if (sensors.ENERGY) {
				        shngInsertText (device+'_voltage', sensors.ENERGY.voltage + 'V', 'energytable', 5);
                        shngInsertText (device+'_current', osensors.ENERGY.current + 'A', 'energytable', 5);
                        shngInsertText (device+'_power', sensors.ENERGY.power + 'W', 'energytable', 5);
                        shngInsertText (device+'_apparent_power', sensors.ENERGY.apparent_power + 'W', 'energytable', 5);
                        shngInsertText (device+'_reactive_power', sensors.ENERGY.reactive_power + 'VA', 'energytable', 5);
                        shngInsertText (device+'_today', sensors.ENERGY.today + 'kWh', 'energytable', 5);
                        shngInsertText (device+'_yesterday', sensors.ENERGY.yesterday + 'kWh', 'energytable', 5);
                        shngInsertText (device+'_total', sensors.ENERGY.total + 'kWh', 'energytable', 5);
                        shngInsertText (device+'_total_starttime', sensors.ENERGY.total_starttime, 'energytable', 5);
	                }
                    if (sensors.DS18B20) {
				        shngInsertText (device+'_DS18B20_temp', sensors.DS18B20.temperature + '°C', 'environtable'), 5;
	                }
                    if (sensors.AM2301) {
				        shngInsertText (device+'_AM2301_temp', sensors.AM2301.temperature + '°C', 'environtable', 5);
                        shngInsertText (device+'_AM2301_hum', sensors.AM2301.humidity + '%rH', 'environtable', 5);
                        shngInsertText (device+'_AM2301_dew', sensors.AM2301.dewpoint + '°C', 'environtable', 5);
	                }
	                if (sensors.SHT3X) {
				        shngInsertText (device+'_SHT3X_temp', sensors.SHT3X.temperature + '°C', 'environtable', 5);
                        shngInsertText (device+'_SHT3X_hum', sensors.SHT3X.humidity + '%rH', 'environtable', 5);
                        shngInsertText (device+'_SHT3X_dew', sensors.SHT3X.dewpoint + '°C', 'environtable', 5);
	                }
                }

                const lights = device_val['lights'];
			    if (lights) {

                    shngInsertText (device+'_hsb', lights.hsb, 'lightstable', 5);
                    shngInsertText (device+'_dimmer', lights.dimmer, 'lightstable', 5);
                    shngInsertText (device+'_color', lights.color, 'lightstable', 5);
                    shngInsertText (device+'_ct', lights.ct, 'lightstable', 5);
                    shngInsertText (device+'_scheme', lights.scheme, 'lightstable', 5);
                    shngInsertText (device+'_fade', lights.fade, 'lightstable', 5);
                    shngInsertText (device+'_speed', lights.speed, 'lightstable', 5);
                    shngInsertText (device+'_ledtable', lights.ledtable, 'lightstable', 5);
                }
                
                const rf = device_val['rf'];
                if (rf) {
                    shngInsertText (device+'_rf_received', rf.rf_received, 'rftable', 5);
                    shngInsertText (device+'_rf_send_result', rf.rf_send_result, 'rftable', 5);
                    shngInsertText (device+'_rfkey_result', rf.rfkey_result, 'rftable', 5);
                }
			}

            for (var zigbee_device in objResponse['tasmota_zigbee_devices']) {
                const zigbee_device_data = objResponse['tasmota_zigbee_devices'][zigbee_device];
                shngInsertText (zigbee_device+'_manufacturer', zigbee_device_datamanufacturer, 'zigbeetable', 5);
                shngInsertText (zigbee_device+'_modelid', zigbee_device_datamodelid, 'zigbeetable', 5);
                shngInsertText (zigbee_device+'_linkquality', zigbee_device_datalinkquality, 'zigbeetable', 5);
                shngInsertText (zigbee_device+'_batterypercentage', zigbee_device_databatterypercentage, 'zigbeetable', 5);
                shngInsertText (zigbee_device+'_lastseenepoch', zigbee_device_datalastseenepoch, 'zigbeetable', 5);
                shngInsertText (zigbee_device+'_data', zigbee_device_data, 'zigbeetable', 5);
			}

			shngInsertText ('broker_uptime', objResponse['broker_uptime'], 'brokertable', 5);
			shngInsertText ('version', objResponse['broker_info']['version'], 'brokertable', 5);
			shngInsertText ('active_clients', objResponse['broker_info']['active_clients'], 'brokertable', 5);
			shngInsertText ('subscriptions', objResponse['broker_info']['subscriptions'], 'brokertable', 5);
			shngInsertText ('stored_messages', objResponse['broker_info']['stored_messages'], 'brokertable', 5);
			shngInsertText ('retained_messages', objResponse['broker_info']['retained_messages'], 'brokertable', 5);

			shngInsertText ('msg_rcv_1min', objResponse['broker_info']['msg_rcv_1min'], 'brokermontable', 5);
			shngInsertText ('msg_rcv_5min', objResponse['broker_info']['msg_rcv_5min'], 'brokermontable', 5);
			shngInsertText ('msg_rcv_15min', objResponse['broker_info']['msg_rcv_15min'], 'brokermontable', 5);
			shngInsertText ('msg_snt_1min', objResponse['broker_info']['msg_snt_1min'], 'brokermontable', 5);
			shngInsertText ('msg_snt_5min', objResponse['broker_info']['msg_snt_5min'], 'brokermontable', 5);
			shngInsertText ('msg_snt_15min', objResponse['broker_info']['msg_snt_15min'], 'brokermontable', 5);
		}
	}
</script>
{% endblock pluginscripts %}

{% block headtable %}
<table class="table table-striped table-hover">
	<tbody>
		<tr>
            <td class="py-1"><strong>{{_('Broker Host')}}</strong></td>
            <td class="py-1">{{ p.broker_config.host }}</td>
            <td class="py-1" width="50px"></td>
            <td class="py-1"><strong>{{_('Broker Port')}}</strong></td>
            <td class="py-1">{{ p.broker_config.port }}</td>
            <td class="py-1" width="50px"></td>
        </tr>
        <tr>
            <td class="py-1"><strong>{{_('Benutzer')}}</strong></td>
            <td class="py-1">{{ p.broker_config.user }}</td>
            <td class="py-1"></td>
            <td class="py-1"><strong>{{_('Passwort')}}</strong></td>
            <td class="py-1">
            {% if p.broker_config.password %}
                {% for letter in p.broker_config.password %}*{% endfor %}
            {% endif %}
            </td>
            <td class="py-1"></td>
        </tr>
        <tr>
            <td class="py-1"><strong>{{_('QoS')}}</strong></td>
            <td class="py-1">{{ p.broker_config.qos }}</td>
            <td class="py-1"></td>
            <td class="py-1"><strong>{{_('full_topic')}}</strong></td>
            <td class="py-1">{{ p.full_topic }}</td>
            <td class="py-1"></td>
        </tr>
    </tbody>
</table>
{% endblock headtable %}

<!--Additional buttons for the web interface (if any are needed) - displayed below the headtable-section-->
{% block buttons %}
{% endblock %}

<!--Define the number of tabs for the body of the web interface (1 - 3)-->
{% set tabcount = 6 %}

<!--Set the tab that will be visible on start, if another tab that 1 is wanted (1 - 3)-->
{% if p.tasmota_items != [] %}
	{% set start_tab = 4 %}
{% endif %}

<!--Set TabTitle-->
{% if items != [] %}
    {% set tab1title = _("<strong>" " Items</strong>") %}
{% else %}
    {% set tab1title = "hidden" %}
{% endif %}

{% set tab2title = _("<strong>" " Devices</strong>") %}

{% set tab3title = _("<strong>" ~ _('Sensor Data') ~ "</strong>") %}

{% if p.tasmota_zigbee_devices %}
    {% set tab4title = _("<strong>" ~ _('Zigbee Devices') ~ "</strong>") %}
{% else %}
    {% set tab4title = "hidden" %}
{% endif %}

{% set tab5title = _("<strong>" " Broker Information</strong>") %}

{% if maintenance %}
    {% set tab6title = _("<strong>" ~ _('Device Details') ~ "</strong>") %}
{% else %}
    {% set tab6title = "hidden" %}
{% endif %}

<!--Content block for Webinterface tabs-->
{% block bodytab1 %}
<caption><h3><strong>Item Information</strong></h3></caption>
<table id="itemtable" class="dataTableAdditional m-2">
    <tbody>
        {% for item in items %}
            <tr>
                {%  if p.get_iattr_value(item.conf, 'tasmota_relay') is in ['1', '2', '3', '4', '5', '6', '7', '8'] %}
                    {% set relais = p.get_iattr_value(item.conf, 'tasmota_relay') %}
                {%  elif p.get_iattr_value(item.conf, 'tasmota_attr') == 'relay' %}
                    {% set relais = "1" %}
                {% else %}
                    {% set relais = "-" %}
                {% endif %}

                <td></td>
                <td class="py-1">{{ item._path }}</td>
                <td class="py-1">{{ item._type }}</td>
                <td class="py-1" id="{{ item._path }}_value">{{ item() }}</td>
                <td class="py-1"> {{ item() }}</td>
                <td class="py-1">{{ relais }}</td>
                <td class="py-1" id="{{ item._path }}_last_update">{{ item.last_update().strftime('%d.%m.%Y %H:%M:%S') }}</td>
                <td class="py-1" id="{{ item._path }}_last_change">{{ item.last_change().strftime('%d.%m.%Y %H:%M:%S') }}</td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}


{% block bodytab2 %}
<div>
    <caption><h3><strong>Device Information</strong></h3></caption>
</div>
<table id="devicetable" class="dataTableAdditional m-2">
    <tbody>
        {% for device in p.tasmota_devices %}
            {% if 'fw_ver' in p.tasmota_devices[device] %}  <!-- Nur die Devices darstellen, die wirklich TASMOTA Devices sind; Zur Prüfung wird die Firmware hergenommen -->
                <tr>
                    {% set device_data = p.tasmota_devices[device] %}

                    {# Set the 'sensors' variable to a comma-separated list of sensor keys, or a hyphen if no sensors are available #}
                    {% if device_data.sensors %}
                        {% set sensors = device_data.sensors.keys() | join(', ') %}
                    {% else %}
                        {% set sensors = "-" %}
                    {% endif %}

                    {# Set the 'sensors' variable to a comma-separated list of sensor keys, or a hyphen if no sensors are available #}
                    {% if device_data.sensors %}
                        {% set sensors = device_data.sensors.keys() | join(', ') %}
                    {% else %}
                        {% set sensors = "-" %}
                    {% endif %}

                    <td></td>
                    <td class="py-1"><a class="text-shng" href="http://{{ device_data.ip }}" target="_blank">{{ device }}</a></td>
                    <td class="py-1" id="{{ device }}_online">{{ device_data.online }}</td>
                    <td class="py-1">{{ device_data.friendly_name }}</td>
                    <td class="py-1">{{ device_data.mac }}</td>
                    <td class="py-1">{{ device_data.ip }}</td>
                    <td class="py-1" id="{{ device }}_uptime">{{ device_data.uptime }}</td>
                    <td class="py-1"> {{ sensors }}</td>
                    <td class="py-1" id="{{ device }}_fw">{{ device_data.fw_ver }}</td>
                    <td class="py-1">{{ device_data.module }}</td>
                    <td class="py-1" id="{{ device }}_wifi">{%  if device_data.wifi_signal %}{{ device_data.wifi_signal }} dBm {% endif %}</td>
                    <td class="py-1">{{ device_data.discovery_config  }}</td>
                </tr>
            {% endif %}
        {% endfor %}
    </tbody>
</table>
{% endblock %}


{% block bodytab3 %}
{% if p.has_energy_sensor() %}
    <caption><h3><strong>ENERGY SENSORS</strong></h3></caption>
    <table id="energytable">
        <thead>
            <tr>
                <th class="plus"></th>
                <th>{{ _('Device') }}</th>
                <th>{{ _('Spannung') }}</th>
                <th>{{ _('Strom') }}</th>
                <th>{{ _('Leistung') }}</th>
                <!--
                <th>{{ _('Schein Leistung') }}</th>
                <th>{{ _('Blind Leistung') }}</th>
                -->
                <th>{{ _('Heute') }}</th>
                <th>{{ _('Gestern') }}</th>
                <th>{{ _('Gesamt') }}</th>
                <th width="200">{{ _('Gesamt - Startzeit') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for device in p.tasmota_devices %}
                {% if p.tasmota_devices[device]['sensors']['ENERGY'] %}
                    <tr>
                        {% set energy_data = p.tasmota_devices[device]['sensors']['ENERGY'] %}
                        <td></td>
                        <td class="py-1"><a class="text-shng" href="http://{{ p.tasmota_devices[device].ip }}" target="_blank">{{ device }}</a></td>
                        <td class="py-1" id="{{ device }}_voltage">{{ energy_data.voltage }}V.</td>
                        <td class="py-1" id="{{ device }}_current">{{ energy_data.current }}A.</td>
                        <td class="py-1" id="{{ device }}_power">{{ energy_data.power }}W</td>
                <!--
                        <td class="py-1" id="{{ device }}_apparent_power">{{ p.tasmota_devices[device]['sensors']['ENERGY'].apparent_power }}W</td>
                        <td class="py-1" id="{{ device }}_reactive_power">{{ p.tasmota_devices[device]['sensors']['ENERGY'].reactive_power }}VA</td>
                -->
                        <td class="py-1" id="{{ device }}_today">{{ energy_data.today }}kWh</td>
                        <td class="py-1" id="{{ device }}_yesterday">{{ energy_data.yesterday }}kWh</td>
                        <td class="py-1" id="{{ device }}_total">{{ energy_data.total}}kWh</td>
                        <td class="py-1" id="{{ device }}_total_starttime">{{ energy_data.total_starttime }}</td>
                    </tr>
                    {% endif %}
            {% endfor %}
        </tbody>
    </table>
    </br>
    </br>
{% endif %}

{% if p.has_env_sensor() %}
    <caption><h3><strong>ENVIRONMENTAL SENSORS</strong></h3></caption>
    <table id="environtable">
        <thead>
            <tr>
                <th class="plus"></th>
                <th>{{ _('Device') }}</th>
                <th>{{ _('Temperatur') }}</th>
                <th>{{ _('Luftfeuchtigkeit') }}</th>
                <th>{{ _('Taupunkt') }}</th>
                <th>{{ _('1w-ID') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for device in p.tasmota_devices %}
                {% if 'DS18B20' in p.tasmota_devices[device].sensors or 'AM2301' in p.tasmota_devices[device].sensors or 'SHT3X' in p.tasmota_devices[device].sensors%}
                    <tr>
                        <td></td>
                        <td class="py-1"><a class="text-shng" href="http://{{ p.tasmota_devices[device].ip }}" target="_blank">{{ device }}</a></td>
                        {% if p.tasmota_devices[device].sensors.DS18B20 %}
                            <td class="py-1" id="{{ device }}_DS18B20_temp">{{ p.tasmota_devices[device].sensors.DS18B20.temperature }}°C</td>
                            <td class="py-1">-</td>
                            <td class="py-1">-</td>
                            <td class="py-1">{{ p.tasmota_devices[device].sensors.DS18B20.id }}</td>
                        {% elif p.tasmota_devices[device].sensors.AM2301 %}
                            <td class="py-1" id="{{ device }}_AM2301_temp">{{ p.tasmota_devices[device].sensors.AM2301.temperature }}°C</td>
                            <td class="py-1" id="{{ device }}_AM2301_hum">{{ p.tasmota_devices[device].sensors.AM2301.humidity }}%rH</td>
                            <td class="py-1" id="{{ device }}_AM2301_dew">{{ p.tasmota_devices[device].sensors.AM2301.dewpoint }}°C</td>
                            <td class="py-1">-</td>
                        {% elif p.tasmota_devices[device].sensors.SHT3X %}
                            <td class="py-1" id="{{ device }}_SHT3X_temp">{{ p.tasmota_devices[device]['sensors']['SHT3X'].temperature }}°C</td>
                            <td class="py-1" id="{{ device }}_SHT3X_hum">{{ p.tasmota_devices[device]['sensors']['SHT3X'].humidity }}%rH</td>
                            <td class="py-1" id="{{ device }}_SHT3X_dew">{{ p.tasmota_devices[device]['sensors']['SHT3X'].dewpoint }}°C</td>
                            <td class="py-1">-</td>
                        {% else %}
                            <td class="py-1">-</td>
                            <td class="py-1">-</td>
                            <td class="py-1">-</td>
                            <td class="py-1">-</td>
                        {% endif %}
                    </tr>
                {% endif %}
            {% endfor %}
            
        </tbody>
    </table>
    </br>
    </br>
{% endif %}

{% if p.has_other_sensor() %}
    <caption><h3><strong>OTHER SENSORS</strong></h3></caption>
    <table id="othersensortable">
        <thead>
            <tr>
                <th class="plus"></th>
                <th>{{ _('Sensor') }}</th>
                <th>{{ _('Sensor Details') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for device in p.tasmota_devices %}
                {% for sensor in p.tasmota_devices[device].sensors %}
                    {% if sensor not in p.SENSORS %}
                        <tr>
                            <td></td>
                            <td class="py-1">{{ sensor }}</td>
                            <td class="py-1" id="{{ device }}_{{ sensor }}">{{ p.tasmota_devices[device].sensors[sensor] }}</td>
                        </tr>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
{% endif %}

{% if p.has_lights() %}
    <caption><h3><strong>LIGHTS</strong></h3></caption>
    <table id="lightstable">
        <thead>
            <tr>
                <th></th>
                <th>{{ _('Device') }}</th>
                <th>{{ _('HSB') }}</th>
                <th>{{ _('Dimmer') }}</th>
                <th>{{ _('Color') }}</th>
                <th>{{ _('CT') }}</th>
                <th>{{ _('Scheme') }}</th>
                <th>{{ _('Fade') }}</th>
                <th>{{ _('Speed') }}</th>
                <th>{{ _('LED-Table') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for device in p.tasmota_devices %}
                {% if p.tasmota_devices[device].lights %}
                    <tr>
                        {% set light_data = p.tasmota_devices[device].lights %}
                        <td></td>
                        <td class="py-1"><a class="text-shng" href="http://{{ p.tasmota_devices[device].ip }}" target="_blank">{{ device }}</a></td>
                        <td class="py-1" id="{{ device }}_hsb">{{ light_data.hsb }}.</td>
                        <td class="py-1" id="{{ device }}_dimmer">{{ light_data.dimmer }}.</td>
                        <td class="py-1" id="{{ device }}_color">{{ light_data.color }}.</td>
                        <td class="py-1" id="{{ device }}_ct">{{ light_data.ct }}.</td>
                        <td class="py-1" id="{{ device }}_scheme">{{ light_data.scheme }}.</td>
                        <td class="py-1" id="{{ device }}_fade">{{ light_data.fade }}.</td>
                        <td class="py-1" id="{{ device }}_speed">{{ light_data.speed }}.</td>
                        <td class="py-1" id="{{ device }}_ledtable">{{ light_data.ledtable }}.</td>
                    </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
    
    </br>
    </br>
{% endif %}

{% if p.has_rf() %}
    <caption><h3><strong>RF</strong></h3></caption>
    <table id="rftable">
        <thead>
            <tr>
                <th></th>
                <th>{{ _('Device') }}</th>
                <th>{{ _('RF-Received') }}</th>
                <th>{{ _('RF-Send Result') }}</th>
                <th>{{ _('RF-Key Result') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for device in p.tasmota_devices %}
                {% if p.tasmota_devices[device].rf%}
                    <tr>
                        {% set rf_data = p.tasmota_devices[device].rf %}
                        <td></td>
                        <td class="py-1"><a class="text-shng" href="http://{{ p.tasmota_devices[device].ip }}" target="_blank">{{ device }}</a></td>
                        <td class="py-1" id="{{ device }}_rf_received">{{ rf_data.rf_received }}</td>
                        <td class="py-1" id="{{ device }}_rf_send_result">{{ rf_data.rf_send_result }}</td>
                        <td class="py-1" id="{{ device }}_rfkey_result">{{ rf_data.rfkey_result }}</td>
                    </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>

    </br>
    </br>
{% endif %}
{% endblock %}


{% block bodytab4 %}
<caption><h3><strong>Zigbee Information</strong></h3></caption>
<table id="zigbeetable">
    <tbody>
        {% for device in p.tasmota_zigbee_devices %}
            <tr>
                {% set zigbee_data = p.tasmota_zigbee_devices[device] %}
                <td></td>
                <td class="py-1">{{ device }}</td>
                <td class="py-1">{{ zigbee_data.ieeeaddr }}</td>
                <td class="py-1" id="{{ device }}_manufacturer">{{ zigbee_data.manufacturer }}</td>
                <td class="py-1" id="{{ device }}_modelid">{{ zigbee_data.modelid }}</td>
                <td class="py-1" id="{{ device }}_linkquality">{{ zigbee_data.linkquality }}</td>
                <td class="py-1" id="{{ device }}_batterypercentage">{{ zigbee_data.batterypercentage }}</td>
                <td class="py-1" id="{{ device }}_lastseenepoch">{{ zigbee_data.lastseenepoch }}</td>
                <td class="py-1" id="{{ device }}_data">{{ zigbee_data }}</td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}


{% block bodytab5 %}
<caption><h3><strong>Broker Information</strong></h3></caption>
<table id="brokertable" class="table table-striped table-hover pluginList">
    <thead>
        <tr>
            <th></th>
            <th class="py-1">{{ _('Merkmal') }}</th>
            <th class="py-1">{{ _('Wert') }}</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td></td>
            <td>{{ 'Broker Version' }}</td>
            <td id="version">{{ p._broker.version }}</td>
        </tr>
        <tr>
            <td></td>
            <td>{{ 'Active Clients' }}</td>
            <td id="active_clients">{{ p._broker.active_clients }}</td>
        </tr>
        <tr>
            <td></td>
            <td>{{ 'Subscriptions' }}</td>
            <td id="subscriptions">{{ p._broker.subscriptions }}</td>
        </tr>
        <tr>
            <td></td>
            <td>{{ 'Messages stored' }}</td>
            <td id="stored_messages">{{ p._broker.stored_messages }}</td>
        </tr>
        <tr>
            <td></td>
            <td>{{ 'Retained Messages' }}</td>
            <td id="retained_messages">{{ p._broker.retained_messages }}</td>
        </tr>
        
        {% if p.broker_monitoring %}
            <tr>
                <td></td>
                <td>{{ _('Laufzeit') }}</td>
                <td id="broker_uptime">{{ p.broker_uptime() }}</td>
            </tr>
        {% endif %}
    </tbody>
</table>

{% if p.broker_monitoring %}
    </br>
    </br>
    <caption><h3><strong>Broker Monitor</strong></h3></caption>
    <table id="brokermontable" class="table table-striped table-hover pluginList">
        <thead>
            <th></th>
            <th class="py-1">{{ _('Message Durchsatz') }}</th>
            <th class="py-1">{{ _('letzte Minute') }}</th>
            <th class="py-1">{{ _('letzte 5 Min.') }}</th>
            <th class="py-1">{{ _('letzte 15 Min.') }}</th>
        </thead>
        <tbody>
            <tr>
                <td></td>
                <td>{{ _('Durchschnittlich Messages je Minute empfangen') }}</td>
                <td id="msg_rcv_1min"> &nbsp; &nbsp; {{ p._broker.msg_rcv_1min }}</td>
                <td id="msg_rcv_5min"> &nbsp; &nbsp; {{ p._broker.msg_rcv_5min }}</td>
                <td id="msg_rcv_15min"> &nbsp; &nbsp; {{ p._broker.msg_rcv_15min }}</td>
            </tr>
            <tr>
                <td></td>
                <td>{{ _('Durchschnittlich Messages je Minute gesendet') }}</td>
                <td id="msg_snt_1min"> &nbsp; &nbsp; {{ p._broker.msg_snt_1min }}</td>
                <td id="msg_snt_5min"> &nbsp; &nbsp; {{ p._broker.msg_snt_5min }}</td>
                <td id="msg_snt_15min"> &nbsp; &nbsp; {{ p._broker.msg_snt_15min }}</td>
            </tr>
        </tbody>
    </table>
{% endif %}

{% endblock %}


{% block bodytab6 %}
<caption><h3><strong>Tasmota Device Details</strong></h3></caption>
<table id="" class="table table-striped table-hover pluginList">
    <thead>
        <tr class="shng_heading">
            <th>{{ _('Tasmota Device') }}</th>
            <th>{{ _('Tasmota Device Details') }}</th>
        </tr>
    </thead>
    <tbody>
        {% for device in p.tasmota_devices %}
            <tr>
                <td>{{ device }}</td>
                <td>{{ p.tasmota_devices[device] }}</td>
            </tr>
        {% endfor %}
    </tbody>
</table>


</br>
</br>

<caption><h3><strong>Tasmota ZigbeeDevice Details</strong></h3></caption>
<table id="" class="table table-striped table-hover pluginList">
    <thead>
        <tr class="shng_heading">
            <th>{{ _('Zigbee Device') }}</th>
            <th>{{ _('Zigbee Device Details') }}</th>
        </tr>
    </thead>
    <tbody>
        {% for device in p.tasmota_zigbee_devices %}
            <tr>
                <td>{{ device }}</td>
                <td>{{ p.tasmota_zigbee_devices[device] }}</td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}



